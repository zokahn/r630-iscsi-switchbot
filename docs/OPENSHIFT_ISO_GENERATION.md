# OpenShift ISO Generation Guide

This document describes how to generate a minimal OpenShift installation ISO using the agent-based installer method. The process focuses on **Day 1 operations** (initial deployment) only, with explicit separation from **Day 2 operations** (post-installation configuration).

## Day 1 vs Day 2 Operations

### Day 1 Operations (Covered by ISO Generator)
The ISO generator focuses exclusively on the minimal configuration required to bootstrap a functional OpenShift cluster:

- Basic cluster identity (name, domain)
- Node networking (IP, MAC address, hostname)
- Access credentials (SSH keys, pull secret)
- Bootstrap disk configuration

### Day 2 Operations (Post-Installation)
More advanced configurations are intentionally left for post-installation:

- Installing and configuring Operators
- Setting up persistent storage
- Configuring advanced networking features
- Implementing monitoring and logging
- Securing the cluster with RBAC and security policies
- Deploying applications and workloads

## Configuration File Structure

The agent-based installer requires two key configuration files, each with specific responsibilities:

### install-config.yaml
- Contains basic cluster-wide settings
- Hosts bootstrap configuration including disk installation targets
- Contains sensitive data such as pull secrets and SSH keys
- Should include:
  - `bootstrapInPlace.installationDisk` for installation target
  - `pullSecret` and `sshKey` for authentication

### agent-config.yaml
- Contains node-specific settings
- Focuses on network and hardware configuration
- Must include:
  - `rendezvousIP` for the bootstrap node
  - Host definitions with MAC addresses
  - Root device hints
  - Does NOT include `bootstrapInPlace` configuration (this belongs in install-config.yaml)

### ⚠️ Common Configuration Issue

A common issue is placing `bootstrapInPlace` configuration in the wrong file. The correct placement is:

```yaml
# In install-config.yaml:
bootstrapInPlace:
  installationDisk: "/dev/sda"  # Or your disk path

# NOT in agent-config.yaml
```

Incorrect placement will result in validation errors when generating the ISO image.

## Requirements

- OpenShift pull secret (from [Red Hat Console](https://console.redhat.com/openshift/install/pull-secret))
- SSH public key (for accessing cluster nodes)
- Valid OpenShift configuration YAML (generated by `generate_openshift_values.py`)
- Internet connection (to download the OpenShift installer)

## Script Usage

### Quick Start

```bash
# Generate the OpenShift configuration first
./scripts/generate_openshift_values.py \
  --node-ip 192.168.2.90 \
  --server-id 01 \
  --cluster-name humpty \
  --base-domain omnisack.nl \
  --hostname humpty \
  --mac-address e4:43:4b:44:5b:10 \
  --installation-disk /dev/sda \
  --generate-default-dns-records

# Generate the ISO using the configuration
./scripts/generate_minimal_iso.py \
  --config config/deployments/r630-01/r630-01-humpty-20250413091118.yaml \
  --version 4.18
```

### Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `--config` | Path to OpenShift configuration YAML file | *Required* |
| `--version` | OpenShift version (e.g., 4.18 or 4.18.0) | 4.18 |
| `--truenas-ip` | TrueNAS IP address for uploading | 192.168.2.245 |
| `--truenas-user` | TrueNAS SSH username | root |
| `--private-key` | Path to SSH private key for TrueNAS | None |
| `--pull-secret` | Path to pull secret file | Auto-detected |
| `--ssh-key` | Path to SSH public key file | ~/.ssh/id_rsa.pub |
| `--skip-upload` | Skip uploading to TrueNAS | False |
| `--output-dir` | Custom output directory | Temporary dir |

## How It Works

1. The script loads your existing OpenShift configuration YAML
2. It extracts essential settings (IP, MAC, hostname, etc.)
3. It generates two minimal YAML files required by the agent-based installer:
   - `install-config.yaml`: Basic cluster configuration
   - `agent-config.yaml`: Host-specific settings
4. It downloads the OpenShift installer matching your version
5. It generates the ISO image using the `openshift-install agent create image` command
6. Optionally uploads the ISO to TrueNAS for network boot

## OpenShift Installer URLs

The script automatically downloads the OpenShift installer binary from Red Hat's mirror server. The URLs follow these patterns:

### Stable Version
- Linux: `https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/stable/openshift-install-linux.tar.gz`
- macOS: `https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/stable/openshift-install-mac.tar.gz`

### Specific Version
- Linux: `https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/4.XX.Y/openshift-install-linux-amd64.tar.gz`
- macOS: `https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/4.XX.Y/openshift-install-mac.tar.gz`

> ⚠️ Note: For macOS, the URL does not include the architecture suffix (amd64) unlike Linux.

## Minimal Configuration Examples

### agent-config.yaml
```yaml
apiVersion: v1beta1
kind: AgentConfig
metadata:
  name: humpty
rendezvousIP: 192.168.2.90
hosts:
  - hostname: humpty
    role: master
    interfaces:
      - macAddress: e4:43:4b:44:5b:10
    rootDeviceHints:
      deviceName: "/dev/sda"
```

### install-config.yaml
```yaml
apiVersion: v1
baseDomain: omnisack.nl
metadata:
  name: humpty
compute:
- name: worker
  replicas: 0
controlPlane:
  name: master
  replicas: 1
networking:
  networkType: OVNKubernetes
  machineNetwork:
  - cidr: 192.168.2.0/24
platform:
  none: {}
bootstrapInPlace:
  installationDisk: "/dev/sda"
pullSecret: '...'  # Redacted
sshKey: '...'  # Redacted
```

This minimal configuration includes:
- Hostname and cluster name
- Node IP and MAC address
- Installation disk
- Bootstrap configuration

## Next Steps After ISO Generation

After generating and booting from the ISO:

1. The node will boot and install OpenShift
2. The cluster will bootstrap and become operational
3. You can then perform Day 2 operations to configure the cluster for your specific needs

Refer to the [OpenShift Documentation](https://docs.openshift.com/container-platform/latest/post_installation_configuration/index.html) for detailed instructions on Day 2 operations.
